---
title: "engsoccerdata FA Cup demo"
output: html_document
---

\  
\  



In this quick tutorial, I shall give a short illustrated example of the sort of question that can be answered using some of the data contained within my `engsoccerdata` package.   I picked the following question more or less at random, but it serves our purpose well...

\  


> Let's say we wanted to know for every season what proportion of teams who got through to the quarter-finals (last eight teams) also did so the following season?   This would be one crude and basic way of assessing the 'competitiveness' of the competition.  


\ 



----

### How do we do this ?

If you haven't already installed the `engsoccerdata` package, then do that:  
```{r, eval=FALSE}
library(devtools)
install_github('jalapic/engsoccerdata', username = "jalapic")

```

\  

Next, load the packages we will need and take a look at the `facup` dataset from `engsoccerdata`.  Because there are 19 variables and they don't all fit nicely across the screen, I shall display them in 2 chunks:


```{r, message=FALSE}

#these are the packages that we will need to have loaded for our data munging and graphing:
library(engsoccerdata)
library(dplyr)
library(tidyr)
library(ggplot2)
library(zoo)
```

\  

```{r}
facup[1:5, 1:14]   #first 5 rows, variables 1-14
```
These first rows give the date of the match, the season (e.g. 1871 refers to 1871/72), the home team, the visiting team, & the final score (regardless of whether this was after 90 minutes or extra time). The final two variables refer to the number of goals scored by the teams in the home and visitor variables respectively.  
\  
\  


The next column refers to the round of the match. This can be 1 to 6, 's' for semi, 'f' for final or '3pp' for third-place playoff (which only occurred 1970/1-1973/4). The 'tie' variable refers to whether the game is an initial tie (first meeting in that round), a replay or something else (a bye, walkover or void match).  The final five variables here refer to penalty shoot-outs but that isn't important right now. 
\   



```{r}
facup[1:5, 15:19]  #first 5 rows, variables 6-13
```
These variables refer to the venue, attendance and other notes and details regarding the circumstances of the individual game.  This isn't important either right now.  
\  



Because we are interested in the last eight teams each season, we should take a look at how many teams are in each round in each year.  To do this, I will only look at initial ties.  This will produce quite a lot of output, but it's probably worth reproducing all of it for this purpose:

```{r}
facup.i <- facup %>% filter(tie=="initial")  
table(facup.i$round, facup.i$Season)
```
Going backwards in time, it's pretty clear that the format is quite orderly from 1946/47 to 2013/14 and that the 6th round has 4 ties (8 teams) in it for each season during this stretch.  In 1945 there was a different format (we'll return to that in a minute). The 6th round also consisted of 4 ties from 1925/26 - 1938/39. From 1905/06 - 1924/25 it was the 4th round that had 4 ties.  From 1888/89 to 1904/05 it was the 3rd round. From 1885/86 - 1887/88 it was the 6th round again with 4 ties.  I won't bother in this tutorial with looking prior to the 1885/86 season as the format was very unwieldy earlier than this.  

\  
In the 1945/46 season, teams played each other in 2 legs for every round prior to the final.  Therefore, we need to look at this season separately, and it is clear that round 6 has 4 ties/8 teams:  
```{r}
facup.45 <- facup %>% filter(Season==1945)  
table(facup.45$round, facup.45$tie)
```

\  
\  

Next we shall use `dplyr` and `tidyr` to collate all the rounds/seasons we need to answer our question. Each series of commands filters the seasons/rounds/ties of interest before creating a neat, two-variable df consisting of 'season' and 'team':

```{r}

#1946/47 - 2013/14
df1<-facup %>% 
  filter(Season<=2013 & Season>=1946) %>%
  filter(tie=="initial" & round=="6") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)


#1945/46
df2<-facup %>% 
  filter(Season==1945) %>%
  filter(tie=="leg1" & round=="6") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)


#1925/26 - 1938/39
df3<-facup %>% 
  filter(Season<=1938 & Season>=1925) %>%
  filter(tie=="initial" & round=="6") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)


#1905/06 - 1924/25
df4<-facup %>% 
  filter(Season<=1924 & Season>=1905) %>%
  filter(tie=="initial" & round=="4") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)


#1888/89 - 1904/05
df5<-facup %>% 
  filter(Season<=1904 & Season>=1888) %>%
  filter(tie=="initial" & round=="3") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)


#1885/86 - 1887/88
df6<-facup %>% 
  filter(Season<=1887 & Season>=1885) %>%
  filter(tie=="initial" & round=="6") %>%
  select(Season,home,visitor) %>%
  gather(key,team,2:3) %>%
  select(Season,team) %>%
  arrange(Season,team)
```

To give an example of what each of these looks like, here are the first 16 rows of 'df1'. You can see here that 'Preston North End' were the only team to appear in both 1946/47 and 1947/48:  

```{r}
head(df1,16)
```
  
\  
\ 
Now we simply bind all of these together and we have our dataframe of 'last 8' teams for 1885/86 - 2013/14...

```{r}
last8 <- rbind(df6,df5,df4,df3,df2,df1)
head(last8)
```


\  \  
Now for the slightly tricky bit. We need to work out the difference in the number of teams from one season to the next. Fortunately this is made easy by using the `setdiff` function. I'm going to run a `for loop` for this, there are probably better ways, but this method is quite easy to deconstruct to illustrate what is going on.  Here, I will build up the steps:

First create a list of each set of 8 teams using `split` on season:
```{r}
last8.l <- split(last8, last8$Season)
```

For example, this is the third season in our data - 1886/87  
```{r}
last8.l[[3]] 
last8.l[[3]][,2] #this just returns a vector of teams, i.e. the 2nd variable
last8.l[[4]][,2] #this returns a vector of teams from the following season

```

Now get the difference between these lists:  
```{r}
setdiff(last8.l[[4]][,2] , last8.l[[3]][,2])
```

Although we can obviously see that 4 teams (Aston Villa, Birmingham St George's, Chatham, Wolverhampton Wanderers) were in the last 8 in 1887/88 that were not in 1886/87, we can automate this process using length:  

```{r}
length(setdiff(last8.l[[4]][,2] , last8.l[[3]][,2])) #which means that 8-4 = 4 teams were the same
```


\   


Let's put all of that in a loop.  We start the loop at the 2nd season as obviously we cannot start at the first as it has no comparison (for the purposes of this tutorial):

```{r}
results <- NULL #create empty vector

for (i in 2:length(last8.l)){
differences <- length(setdiff(last8.l[[i]][,2] , last8.l[[i-1]][,2]))
results[[i]] <- 8 - differences
}

```
\  

The results show the number of teams in the last 8 who were also in the season before:  

```{r}
results
```

\  

We can calculate the number of times that every team that has reached the last eight did not the previous year.  
```{r}
sum(results==0, na.rm=T) 
```

\  

\  

We could also do a simple histogram plot  
```{r}
hist(results, col="lightblue", breaks=c(0,1,2,3,4,5,6,7,8), main="Numer of teams reaching conseuctive quarter-finals", xlab="Number of teams") 
```

\  
Let's make that into a dataframe and add season as a varaiable too:
```{r}
mydf <- data.frame(Season = names(last8.l), sameteams = results)
head(mydf)
```


\  
It's pretty clear from the above data that the pattern of the number of same teams making it into the last 8 is quite constant from year to year.  To detect patterns, it might be worthwhile to add a moving average - say of every 5 years.

```{r}
rollapply(mydf$sameteams, width=5, FUN=mean, fill=NA, align=c("right"))  #from library(zoo)


mydf$movavg <- rollapply(mydf$sameteams, width=5, FUN=mean, fill=NA, align=c("right"))  #add into mydf

head(mydf, 10)
```

\  
Before we graph it, I want to add some years so that gaps will appear along the x-axis for the two World Wars.
```{r}
setdiff(1885:2013,names(last8.l)) #get those years not included

mydfNA <- data.frame(Season = setdiff(1885:2013, names(last8.l)), sameteams = NA, movavg = NA)  #create a df we can append to mydf 

mydf$Season <- as.numeric(as.character(mydf$Season)) #need to make sure that season is a number not a factor


mydf <- rbind(mydf, mydfNA) #this ensures that the war years are gaps when doing a line graph

```

\  




Now let's plot:
```{r, message=FALSE}
ggplot(mydf, aes(Season, movavg)) + 
       geom_point(color="navy", size=2.5) + 
       geom_line(aes(group=1), lwd=1, color="dodgerblue") +
         scale_x_continuous(breaks=c(seq(1880,2020,10))) +
       ggtitle("Total teams in last 8 of the FA Cup in consecutive seasons: 1885-2014") + 
       ylab("Total teams") +
  theme(
    panel.grid.major.x = element_line(color="gray55"),
    panel.grid.major.y = element_line(color="gray55"),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background  = element_rect(color = "ghostwhite"),
    panel.background = element_blank(),
    plot.title = element_text(hjust=0,vjust=1)
    )

```

\  
My first impression of this plot is that there does appear to be a decline in the number of the same teams appearing in the last 8 from 1885 (averaging 4 of the same teams, season to season) to less than 2 teams repeating in the mid 1920s and mid 1930s.   If increased parity is equivalent to a more exciting competition, then it appears that the mid 1970s and mid 1990s were very exciting as very few teams repeated getting into the last 8 in consecutive seasons.   There also seems to be an increasing trend towards less parity / increased competitiveness since the beginning of the 21st century, which may be tailing off in the last few seasons.   However,  the ups-and-downs seen in the second half of this chart could easily be due to random noise rather than any meaningful trends.     

This is just a quick example of how easy it is to turn all of this data into something visually appealing that can stimulate further research questions and ideas.


If you're interested in this and what to learn more or discuss, please get in touch with me -   jc3181 AT columbia DOT edu
